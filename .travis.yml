language: node_js
node_js:
  - 10.8
addons:
  apt:
    packages:
    # Ubuntu 16+ does not install this dependency by default, so we need to install it ourselves
    - libgconf-2-4
services:
  - mongodb
before_install:
  # clone mt-sso
  - "cd .."
  - "git clone --branch=fixTravisTests https://github.com/DanielJKelly/mt-sso.git"
  - "cd mt-sso"
  - "nvm install 8.6.0"
  - "nvm use 8.6.0"
  - "npm i"
  - "npm run test-travis &"
  - "sleep 5"
  # clone encompass
  - "cd .."
  - "git clone --branch=fixTravisTests https://github.com/DanielJKelly/encompass.git"
  - "cd encompass && npm i --only=production"
  - "npm run test-travis &"
  - "sleep 6"
  - "cd ../vmt"

install:
  - cd server
  - nvm use 10.8
  - npm ci
  - npm install
  - npm --prefix ../client install ../client
  - npm run build-production-test
cache:
  npm: true
  directories:
    - ~/.cache
    - client/node_modules
before_script:
  ## we use the '&' ampersand which tells
  ## travis to run this process in the background
  ## else it would block execution and hang travis
  - NODE_ENV=test REACT_APP_IS_TEST=true node ./bin/www &
  - npm run client &
  - sleep 6
script:
  - npm run cypress:run
  - cypress run --browser electron --record --key 103dfac6-8e4d-4672-adf9-b661fb7738da --parallel --group $STAGE_NAME
  #  ADD THIS TO PACKAGE>JSON CYPRESS SCRUPT
jobs:
  include:
    # we have multiple jobs to execute using just a single stage
    # but we can pass group name via environment variable to Cypress test runner
    - stage: test
      env:
        - STAGE_NAME="1x-electron on Travis CI"
      <<: *defaults
    # run tests in parallel by including several test jobs with same name variable
    - stage: test
      env:
        - STAGE_NAME="4x-electron on Travis CI"
      <<: *defaults
    - stage: test
      env:
        - STAGE_NAME="4x-electron on Travis CI"
      <<: *defaults
    - stage: test
      env:
        - STAGE_NAME="4x-electron on Travis CI"
      <<: *defaults
    - stage: test
      env:
        - STAGE_NAME="4x-electron on Travis CI"
      <<: *defaults
